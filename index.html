<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Command Input</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/5.5.0/xterm.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/5.5.0/xterm.js"></script>
</head>

<body>
    <h1>Send Commands to Gemini</h1>
    <textarea id="command-input" rows="10" cols="50" placeholder="Type commands here..."></textarea>
    <h2>Output</h2>
    <div id="terminal"></div>
    <script>
        const textarea = document.getElementById('command-input');

        textarea.addEventListener('keydown', (e) => {
            let char = '';
            if (e.key === 'Enter') {
                char = '\r';  // Send carriage return (\r)
                textarea.value += '\n';
            } else if (e.key === 'Backspace') {
                char = '\b';
                textarea.value = textarea.value.slice(0, -1);
            } else if (e.key === 'Tab') {
                char = '\t';
                textarea.value += '\t';
            } else if (e.key === 'ArrowUp') {
                char = '\x1b[A';
            } else if (e.key === 'ArrowDown') {
                char = '\x1b[B';
            } else if (e.key === 'ArrowRight') {
                char = '\x1b[C';
            } else if (e.key === 'ArrowLeft') {
                char = '\x1b[D';
            } else if (e.key.length === 1) {
                char = e.key;
                textarea.value += e.key;
            } else {
                return; // ignore other keys
            }

            fetch('http://localhost:3000/command', {
                method: 'POST',
                body: char
            }).catch(err => console.error('Error sending command:', err));

            e.preventDefault();
        });

        // Receive output via SSE
        const eventSource = new EventSource('http://localhost:3000/output');
        var term = new Terminal();
        term.open(document.getElementById('terminal'));

        eventSource.onopen = () => {
            console.log('SSE connected');
        };
        eventSource.onmessage = (event) => {
            if (!event.data) return;
            try {
                const data = atob(event.data);
                term.write(data);
            } catch (e) {
                console.error('Error decoding base64 data:', e);
            }
        };
        eventSource.onerror = (err) => {
            console.error('SSE error:', err);
        };
    </script>
</body>

</html>